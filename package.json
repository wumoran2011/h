const puppeteer = require('puppeteer');
const fs = require('fs');

async function advancedCheckin() {
  console.log('ğŸš€ å¼€å§‹é«˜çº§ç­¾åˆ°å°è¯•...');
  
  const browser = await puppeteer.launch({
    headless: false, // æ”¹ä¸ºéæ— å¤´æ¨¡å¼
    args: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-web-security',
      '--disable-features=IsolateOrigins,site-per-process',
      '--disable-blink-features=AutomationControlled',
      '--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    ]
  });

  try {
    const page = await browser.newPage();
    
    // éšè—è‡ªåŠ¨åŒ–ç‰¹å¾
    await page.evaluateOnNewDocument(() => {
      Object.defineProperty(navigator, 'webdriver', { get: () => undefined });
      Object.defineProperty(navigator, 'languages', { get: () => ['zh-CN', 'zh', 'en'] });
      Object.defineProperty(navigator, 'plugins', { get: () => [1, 2, 3, 4, 5] });
    });
    
    await page.setViewport({ width: 1366, height: 768 });
    await page.setDefaultNavigationTimeout(120000);
    
    console.log('ğŸŒ å°è¯•è®¿é—®ç½‘ç«™...');
    
    // å…ˆè®¿é—®ä¸€ä¸ªä¸­æ€§ç½‘ç«™ï¼Œå»ºç«‹"æ­£å¸¸"çš„æµè§ˆå†å²
    await page.goto('https://www.google.com', { waitUntil: 'networkidle2' });
    await page.waitForTimeout(2000);
    
    // ç„¶åè®¿é—®ç›®æ ‡ç½‘ç«™
    await page.goto('https://bdsm88.com', {
      waitUntil: 'networkidle2',
      timeout: 120000
    });
    
    await page.waitForTimeout(10000); // ç­‰å¾…10ç§’
    
    // æ£€æŸ¥æ˜¯å¦è¢« Cloudflare æ‹¦æˆª
    const pageTitle = await page.title();
    const currentUrl = await page.url();
    
    console.log(`ğŸ“„ é¡µé¢æ ‡é¢˜: ${pageTitle}`);
    console.log(`ğŸ”— å½“å‰URL: ${currentUrl}`);
    
    await page.screenshot({ path: 'cloudflare-check.png', fullPage: true });
    
    if (pageTitle.includes('Just a moment') || currentUrl.includes('challenge')) {
      console.log('âŒ ä»ç„¶è¢« Cloudflare æ‹¦æˆª');
      fs.writeFileSync('status.txt', 'CLOUDFLARE_BLOCKED');
      
      // å°è¯•ç­‰å¾…è‡ªåŠ¨éªŒè¯
      console.log('â³ ç­‰å¾…å¯èƒ½çš„è‡ªåŠ¨éªŒè¯...');
      await page.waitForTimeout(15000);
      
      // å†æ¬¡æ£€æŸ¥
      const newTitle = await page.title();
      if (!newTitle.includes('Just a moment')) {
        console.log('âœ… å¯èƒ½é€šè¿‡äº†éªŒè¯ï¼');
        fs.writeFileSync('status.txt', 'POSSIBLE_SUCCESS');
      } else {
        console.log('âŒ éªŒè¯æœªé€šè¿‡');
        return;
      }
    }
    
    // ç»§ç»­ç­¾åˆ°æµç¨‹...
    console.log('ğŸ“„ å‰å¾€ç­¾åˆ°é¡µé¢...');
    await page.goto('https://bdsm88.com/discussion', {
      waitUntil: 'networkidle2',
      timeout: 60000
    });
    
    await page.waitForTimeout(5000);
    await page.screenshot({ path: 'discussion-page.png', fullPage: true });
    
    // è¿™é‡Œå¯ä»¥ç»§ç»­æ·»åŠ ç™»å½•å’Œç­¾åˆ°é€»è¾‘...
    
  } catch (error) {
    console.error('âŒ å‡ºé”™:', error);
    fs.writeFileSync('error.txt', `ERROR: ${error.message}`);
  } finally {
    await browser.close();
    console.log('ğŸ”š å®Œæˆ');
  }
}

advancedCheckin();
