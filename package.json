const puppeteer = require('puppeteer');
const fs = require('fs');

async function advancedCheckin() {
  console.log('🚀 开始高级签到尝试...');
  
  const browser = await puppeteer.launch({
    headless: false, // 改为非无头模式
    args: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-web-security',
      '--disable-features=IsolateOrigins,site-per-process',
      '--disable-blink-features=AutomationControlled',
      '--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    ]
  });

  try {
    const page = await browser.newPage();
    
    // 隐藏自动化特征
    await page.evaluateOnNewDocument(() => {
      Object.defineProperty(navigator, 'webdriver', { get: () => undefined });
      Object.defineProperty(navigator, 'languages', { get: () => ['zh-CN', 'zh', 'en'] });
      Object.defineProperty(navigator, 'plugins', { get: () => [1, 2, 3, 4, 5] });
    });
    
    await page.setViewport({ width: 1366, height: 768 });
    await page.setDefaultNavigationTimeout(120000);
    
    console.log('🌐 尝试访问网站...');
    
    // 先访问一个中性网站，建立"正常"的浏览历史
    await page.goto('https://www.google.com', { waitUntil: 'networkidle2' });
    await page.waitForTimeout(2000);
    
    // 然后访问目标网站
    await page.goto('https://bdsm88.com', {
      waitUntil: 'networkidle2',
      timeout: 120000
    });
    
    await page.waitForTimeout(10000); // 等待10秒
    
    // 检查是否被 Cloudflare 拦截
    const pageTitle = await page.title();
    const currentUrl = await page.url();
    
    console.log(`📄 页面标题: ${pageTitle}`);
    console.log(`🔗 当前URL: ${currentUrl}`);
    
    await page.screenshot({ path: 'cloudflare-check.png', fullPage: true });
    
    if (pageTitle.includes('Just a moment') || currentUrl.includes('challenge')) {
      console.log('❌ 仍然被 Cloudflare 拦截');
      fs.writeFileSync('status.txt', 'CLOUDFLARE_BLOCKED');
      
      // 尝试等待自动验证
      console.log('⏳ 等待可能的自动验证...');
      await page.waitForTimeout(15000);
      
      // 再次检查
      const newTitle = await page.title();
      if (!newTitle.includes('Just a moment')) {
        console.log('✅ 可能通过了验证！');
        fs.writeFileSync('status.txt', 'POSSIBLE_SUCCESS');
      } else {
        console.log('❌ 验证未通过');
        return;
      }
    }
    
    // 继续签到流程...
    console.log('📄 前往签到页面...');
    await page.goto('https://bdsm88.com/discussion', {
      waitUntil: 'networkidle2',
      timeout: 60000
    });
    
    await page.waitForTimeout(5000);
    await page.screenshot({ path: 'discussion-page.png', fullPage: true });
    
    // 这里可以继续添加登录和签到逻辑...
    
  } catch (error) {
    console.error('❌ 出错:', error);
    fs.writeFileSync('error.txt', `ERROR: ${error.message}`);
  } finally {
    await browser.close();
    console.log('🔚 完成');
  }
}

advancedCheckin();
